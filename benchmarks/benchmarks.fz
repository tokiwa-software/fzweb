# -----------------------------------------------------------------------
#
#  Tokiwa Software GmbH, Germany
#
#  Source code of Fuzion webserver feature benchmarks
#
#  for running benchmarks of webserver code
#
#  NOTE: that this is not part of a running webserver
#
# -----------------------------------------------------------------------


benchmarks =>

  duration := time.duration.s 10
  warmup := time.duration.s 2

  feed := Feeds

  b(f ()->unit) =>
    bench warmup duration f


  session_document_get_content(where String) =>
    x := io.Out.instate _ io.Out.blackhole ()->
      s := Session (lock_free.Sieve_Cache String Session 100) feed (net.ip_address u128.zero) nil
      sd := session_document where s
      _ := sd.get_content feed

      b ()->
        _ := sd.get_content feed

    say "session_document.get_content {where} iter/s: {x}"


  session_event_msg(where String) =>
    x := io.Out.instate _ io.Out.blackhole ()->
      s := Session (lock_free.Sieve_Cache String Session 100) feed (net.ip_address u128.zero) nil
      s.set_current where

      b ()->
        _ := s.event_msg

    say "Session.event_msg {where} iter/s: {x}"


  session_document_get_content "tutorial"
  session_document_get_content "news"
  session_document_get_content "."
  session_event_msg "tutorial"
  session_event_msg "news"
  session_event_msg "."
