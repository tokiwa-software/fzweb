# -----------------------------------------------------------------------
#
#  Tokiwa Software GmbH, Germany
#
#  Source code of Fuzion webserver feature benchmarks
#
#  for running benchmarks of webserver code
#
#  NOTE: that this is not part of a running webserver
#
# -----------------------------------------------------------------------


benchmarks =>

  duration := time.duration.s 5
  warmup := time.duration.s 1

  b(f ()->unit) =>
    bench warmup duration f


  session_document_get_content(where String) =>
    x := io.Out.instate _ io.Out.blackhole ()->
      s := Session (net.ip_address u128.zero) nil
      sd := session_document where s
      _ := sd.get_content
      b ()->
        _ := sd.get_content

    say "session_document.get_content {where} iter/s: {x}"


  session_event_msg(where String) =>
    x := io.Out.instate _ io.Out.blackhole ()->
      s := Session (net.ip_address u128.zero) nil
      s.set_current where

      b ()->
        msg := s.event_msg
        say "{msg.byte_length.hex}\r\n{msg}\r\n"

    say "Session.event_msg {where} iter/s: {x}"

  g := io.Out.instate _ io.Out.blackhole ()->
    global

  sites := [
    "idioms/index",
    "docs/base/index",
    "tutorial/index",
    "news/index",
    "index"
  ]

  g ! ()->
    for s in sites do
      session_event_msg s
    for s in sites do
      session_document_get_content s
