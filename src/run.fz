# -----------------------------------------------------------------------
#
#  Tokiwa Software GmbH, Germany
#
#  Source code of Fuzion webserver feature run
#
# -----------------------------------------------------------------------

# run -- feature that starts up the Fuzion webserver
#
run =>

  feeds := Feeds
  feeds.init

  # single instance of webserver for holding state like sessions, feeds etc.
  #
  webserver := webserver (lock_free.Map String Session).empty feeds

  _ :=
    Webserver 8080 net.family.ipv4 (str -> logger.log str) [except (str -> logger.log str)] req->
      # NYI: UNDER DEVELOPMENT: need option for Webserver to instate effect per request
      _ := mut
      webserver.handle_connection mutate req


  # NYI: UNDER DEVELOPMENT:
  # ws.until_shutdown
  do
    time.nano.sleep (time.duration.min 1)

