# -----------------------------------------------------------------------
#
#  Tokiwa Software GmbH, Germany
#
#  Source code of Fuzion webserver feature url_encoded
#
# -----------------------------------------------------------------------

module url_encoded is


  # Parse URL-encoded form data into a map
  #
  module parse_urlencoded_map(data String) lock_free.Map String String =>

    pairs := data.split "&"
    form_data := lock_free.Map String String .empty
    for p in pairs do
      nv := p.split "="
      name := encodings.percent.decode_as_str nv[0] .val.trim
      _ := form_data.put name (nv.count < 2 ? "" : encodings.percent.decode_as_str nv[1] .val)
    form_data



  # HTML-encode a string
  #
  module html_encode(s String) String =>

    for res := "", (if c = "32"
                      res + "&nbsp;"
                    else if c = "38"
                      res + "&amp;"
                    else if c = "60"
                      res + "&lt;"
                    else if c = "62"
                      res + "&gt;"
                    else if c = "34"
                      res + "&quot;"
                    else if c = "39"
                      res + "&#x27;"
                    else if c = "47"
                      res + "&#x2F;"
                    else
                      res + c)
        c in s.as_codepoints
        i := 0, i + 1
    else
      res


  # Encode HTML data with newlines preserved
  #
  module encode_html_data(s String) String =>

    for res := "data: ", (if c = "10"
                            res + "\ndata: "
                          else
                            res + html_encode(c))
        c in s.as_codepoints
        i := 0, i + 1
    else
      res := res + "\n"
      res
